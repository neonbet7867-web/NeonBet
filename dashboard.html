<!-- filename: dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pro Trading App</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  /* ---------- BASE STYLES ---------- */
  :root {
    --bg-body: #f8f9fa;       
    --card-dark: #212529;     
    --primary-green: #22c55e; 
    --primary-red: #ef4444;   
    --text-dark: #333333;
    --gray-border: #e9ecef;
    --gold: #fbbf24;
    --silver: #9ca3af;
    --bronze: #b45309;
  }

  * { box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
  
  body {
    margin: 0; min-height: 100vh;
    background: var(--bg-body);
    display: flex; justify-content: center; 
    padding: 0; 
  }

  .wrap {
    width: 100%; max-width: 480px; margin: 0 auto;
    background: #ffffff; min-height: 100vh; 
    display: none; flex-direction: column; 
    padding-bottom: 80px;
  }

  /* TICKER */
  .live-activity {
    background: #fff; padding: 10px; border-bottom: 1px solid var(--gray-border);
    height: 50px; overflow: hidden; display: flex; align-items: center;
  }
  .ticker-box { width: 100%; position: relative; height: 30px; overflow: hidden; }
  .tick-item {
    font-size: 13px; font-weight: 500; display: flex; gap: 10px; align-items: center;
    color: var(--text-dark); animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp { from{transform:translateY(10px); opacity:0;} to{transform:translateY(0); opacity:1;} }
  .t-green { color: var(--primary-green); font-weight: 700; }
  
  /* HEADER CARD */
  .header-card {
    margin: 15px; background: var(--card-dark); color: white;
    border-radius: 16px; padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative;
  }
  .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .brand { font-weight: 900; font-size: 18px; color: #fff; letter-spacing: 0.5px; }
  .brand span { color: var(--primary-green); }
  
  .wallet-label { font-size: 12px; color: #ced4da; margin-bottom: 5px; }
  .wallet-amount { font-size: 32px; font-weight: 700; color: #fff; }

  .card-actions { display: flex; gap: 10px; margin-top: 15px; }
  .action-btn {
    flex: 1; padding: 10px; border-radius: 8px; border: none;
    font-size: 13px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 5px;
    transition: transform 0.1s;
  }
  .action-btn:active { transform: scale(0.95); }
  .btn-dep { background: var(--primary-green); color: white; }
  .btn-wd { background: rgba(255,255,255,0.2); color: white; }

  /* TIMER */
  .timer-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 15px; }
  .period-txt { font-size: 14px; color: #6c757d; font-weight: 500; }
  .timer-box {
    background: #e9ecef; padding: 6px 12px; border-radius: 6px;
    font-size: 18px; font-weight: 700; letter-spacing: 1px;
    font-family: monospace; color: var(--text-dark);
  }

  /* BET BUTTONS */
  .bet-section { padding: 0 15px; margin-bottom: 25px; }
  .input-group { margin-bottom: 15px; }
  .input {
    width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px;
    font-size: 16px; font-weight: 500; background: #fff;
  }
  .bet-buttons-row { display: flex; gap: 15px; }
  .big-btn {
    flex: 1; height: 90px; border: none; border-radius: 12px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; cursor: pointer; transition: transform 0.1s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .big-btn:active { transform: scale(0.97); }
  .big-btn i { font-size: 24px; margin-bottom: 5px; }
  .big-btn span { font-size: 16px; font-weight: 700; }
  .btn-green { background: var(--primary-green); box-shadow: 0 4px 0 #15803d; }
  .btn-red { background: var(--primary-red); box-shadow: 0 4px 0 #b91c1c; }
  .big-btn:disabled, .big-btn.locked { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; box-shadow: none; transform: translateY(4px); }

  /* HISTORY */
  .section-header { 
      padding: 0 15px; font-size: 14px; font-weight: 700; color: #495057; margin-bottom: 10px; 
      display: flex; justify-content: space-between; align-items: center;
  }
  .history-list { padding: 0 15px; min-height: 50px; }
  .hist-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px; background: white; border-bottom: 1px solid #f1f1f1;
  }
  .hist-row:first-child { border-top: 1px solid #f1f1f1; }
  .hist-badge { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }

  /* ðŸ”¥ PODIUM & LEADERBOARD STYLES (NEW) ðŸ”¥ */
  .leaderboard-container { margin-top: 30px; padding: 0 15px; }
  
  .podium-box {
    display: flex; align-items: flex-end; justify-content: center; gap: 10px;
    margin-bottom: 20px; padding-top: 20px;
  }
  .podium-item {
    display: flex; flex-direction: column; align-items: center; text-align: center;
    position: relative;
  }
  /* Rank 1 (Center) */
  .p-rank-1 { order: 2; z-index: 2; margin-bottom: 10px; } 
  .p-rank-1 .p-avatar { width: 70px; height: 70px; border: 3px solid var(--gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
  .p-rank-1 .p-crown { display: block; position: absolute; top: -22px; font-size: 24px; color: var(--gold); animation: float 2s infinite ease-in-out; }
  
  /* Rank 2 (Left) */
  .p-rank-2 { order: 1; }
  .p-rank-2 .p-avatar { width: 55px; height: 55px; border: 3px solid var(--silver); }
  
  /* Rank 3 (Right) */
  .p-rank-3 { order: 3; }
  .p-rank-3 .p-avatar { width: 55px; height: 55px; border: 3px solid var(--bronze); }

  .p-avatar {
    border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center;
    font-weight: 700; color: #475569; font-size: 18px; margin-bottom: 8px; overflow: hidden;
  }
  .p-name { font-size: 11px; font-weight: 700; color: #334155; margin-bottom: 2px; }
  .p-win { font-size: 12px; font-weight: 700; color: var(--primary-green); }
  
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  .leaderboard-list {
    background: #fff; border-radius: 12px; border: 1px solid #e9ecef;
    overflow: hidden; max-height: 400px; overflow-y: auto;
  }
  .lb-header {
    background: linear-gradient(135deg, #1e293b, #0f172a); color: white; 
    padding: 12px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px;
  }
  .lb-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 15px; border-bottom: 1px solid #f1f5f9; font-size: 12px;
  }
  .lb-left { display: flex; align-items: center; gap: 12px; }
  .lb-rank {
    width: 20px; height: 20px; background: #f1f5f9; border-radius: 4px;
    display: flex; align-items: center; justify-content: center; font-weight: 700; color: #64748b; font-size: 10px;
  }
  .lb-email { font-weight: 600; color: #334155; }
  .lb-win { font-weight: 700; color: var(--primary-green); }

  /* Footer & Modals */
  .footer-menu {
    position: fixed; bottom: 0; width: 100%; max-width: 480px;
    background: white; border-top: 1px solid #eee;
    display: flex; justify-content: space-around; padding: 10px 0;
    z-index: 100;
  }
  .menu-item { text-align: center; color: #adb5bd; font-size: 10px; cursor: pointer; }
  .menu-item i { font-size: 18px; display: block; margin-bottom: 4px; }
  .menu-item.active { color: var(--primary-green); }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100000;
    background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
  .modal-content { width: 90%; max-width: 400px; background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
  @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  
  .std-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; }
  .btn-g { background: var(--primary-green); color: white; }
  .btn-r { background: var(--primary-red); color: white; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .modal-title { font-weight: 900; font-size: 18px; color: var(--text-dark); }
  .close-icon { font-size: 20px; cursor: pointer; color: #aaa; padding: 5px; }
  
  #popupContainer { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 320px; z-index: 99999; pointer-events: none; }
  .popup {
    padding: 12px 20px; border-radius: 30px; text-align: center; color: white; font-weight: 600; font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s; transform: translateY(-10px); background: #333;
  }
  .popup.show { opacity: 1; transform: translateY(0); }
  .popup.win { background: var(--primary-green); }
  .popup.lose { background: var(--primary-red); }

  @media (min-width: 769px) {
    .wrap { display: flex !important; margin-top: 20px; margin-bottom: 20px; border-radius: 20px; }
    body { background: #e9ecef; }
  }
</style>
</head>
<body>

<!-- AGGREGATOR -->
<script>
(function(global){'use strict';const CONFIG={maxEvents:1000};const _store={events:[],metrics:{totalRequests:0,bytesReceived:0,errors:0,methods:{},domains:{},statusCodes:{}},isAggregating:false,listeners:[]};const originalFetch=global.fetch;const originalXHR=global.XMLHttpRequest;function getDomain(url){try{return new URL(url,global.location.origin).hostname}catch(e){return'unknown'}}function emitUpdate(){_store.listeners.forEach(cb=>{try{cb(getSnapshot())}catch(e){console.error('[Aggregator] Listener error',e)}})}function recordEvent(data){if(!_store.isAggregating)return;const entry={id:Date.now()+Math.random().toString(36).substr(2,5),timestamp:new Date().toISOString(),...data};_store.events.push(entry);if(_store.events.length>CONFIG.maxEvents){_store.events=_store.events.slice(_store.events.length-CONFIG.maxEvents)}_store.metrics.totalRequests++;if(data.status>=400||data.error)_store.metrics.errors++;const domain=getDomain(data.url);_store.metrics.domains[domain]=(_store.metrics.domains[domain]||0)+1;if(data.status)_store.metrics.statusCodes[data.status]=(_store.metrics.statusCodes[data.status]||0)+1;if(data.size)_store.metrics.bytesReceived+=data.size;emitUpdate()}function installInterceptors(){console.log('%c[Aggregator] System Active','color:#00ffd7;font-weight:bold');global.fetch=async function(input,init){const startTime=performance.now();let url=input;if(input instanceof Request)url=input.url;const method=(init&&init.method)?init.method:'GET';try{const response=await originalFetch.apply(this,arguments);const clone=response.clone();clone.blob().then(blob=>{const duration=Math.round(performance.now()-startTime);recordEvent({type:'fetch',url:String(url),method:method,status:response.status,duration:duration,size:blob.size})}).catch(()=>{});return response}catch(err){const duration=Math.round(performance.now()-startTime);recordEvent({type:'fetch',url:String(url),method:method,status:0,duration:duration,error:err.message});throw err}};const XHRProxy=function(){const xhr=new originalXHR();this._xhr=xhr;this._metadata={method:'GET',url:''};const props=['status','statusText','responseType','response','responseText','responseXML','readyState','onreadystatechange','onload','onerror','withCredentials','upload'];props.forEach(prop=>{Object.defineProperty(this,prop,{get:()=>xhr[prop],set:(val)=>{xhr[prop]=val}})})};XHRProxy.prototype.open=function(method,url){this._metadata.method=method;this._metadata.url=url;this._metadata.startTime=performance.now();return this._xhr.open.apply(this._xhr,arguments)};XHRProxy.prototype.setRequestHeader=function(header,value){return this._xhr.setRequestHeader.apply(this._xhr,arguments)};XHRProxy.prototype.send=function(body){const self=this;this._xhr.addEventListener('loadend',function(){const duration=Math.round(performance.now()-self._metadata.startTime);let size=0;try{if(self._xhr.responseType===''||self._xhr.responseType==='text')size=(self._xhr.responseText||'').length}catch(e){}recordEvent({type:'xhr',url:self._metadata.url,method:self._metadata.method,status:self._xhr.status,duration:duration,size:size})});return this._xhr.send.apply(this._xhr,arguments)};global.XMLHttpRequest=XHRProxy}function uninstallInterceptors(){global.fetch=originalFetch;global.XMLHttpRequest=originalXHR;console.log('[Aggregator] Stopped')}function getSnapshot(){return JSON.parse(JSON.stringify({timestamp:new Date().toISOString(),metrics:_store.metrics,recentEvents:_store.events}))}function exportData(format='json'){const data=getSnapshot();if(format==='csv'){const headers=['Timestamp','Type','Method','Status','Duration(ms','URL'];const rows=data.recentEvents.map(e=>`"${e.timestamp}","${e.type}","${e.method}","${e.status}","${e.duration}","${e.url}"`);return[headers.join(','),...rows].join('\n')}return JSON.stringify(data,null,2)}const API={start:()=>{if(!_store.isAggregating){_store.isAggregating=true;installInterceptors()}},stop:()=>{_store.isAggregating=false;uninstallInterceptors()},getSnapshot,exportData,subscribe:(cb)=>_store.listeners.push(cb)};global.AggregatorSystem=API;API.start()})(window);
</script>

<div class="wrap">
  
  <!-- TICKER -->
  <div class="live-activity">
      <div id="tickerBox" class="ticker-box"></div>
  </div>

  <!-- HEADER CARD (Name & Email at Top) -->
  <div class="header-card">
    <div class="top-row">
        <div class="brand">Neon<span>BET</span></div>
        <div id="logoutBtn" style="font-size:11px; opacity:0.7; cursor:pointer;">LOGOUT</div>
    </div>
    <div class="wallet-info">
        <div class="wallet-label">Total Balance</div>
        <div class="wallet-amount">â‚¹ <span id="wallet">0</span></div>
        <div style="font-size:11px; color:#e0e0e0; margin-top:5px; display:flex; gap:6px; align-items:center;">
            <i class="fas fa-user-circle"></i> <span id="displayEmail">Loading...</span>
        </div>
    </div>
    
    <div class="card-actions">
        <button class="action-btn btn-dep" onclick="document.getElementById('depositModal').classList.add('active')">
            <i class="fas fa-plus"></i> Deposit
        </button>
        <button class="action-btn btn-wd" onclick="document.getElementById('withdrawModal').classList.add('active')">
            <i class="fas fa-arrow-down"></i> Withdraw
        </button>
    </div>
  </div>

  <!-- TIMER -->
  <div class="timer-bar">
      <div>
          <div class="period-txt">Period</div>
          <div style="font-weight:700; font-size:16px;">#<span id="roundNo">Loading</span></div>
      </div>
      <div style="text-align:right;">
          <div class="period-txt" style="text-align:right;">Time Left</div>
          <div class="timer-box">
            <span id="timeLeft">60</span> : 00
          </div>
      </div>
  </div>

  <!-- BET BUTTONS -->
  <div class="bet-section">
    <div class="input-group">
        <input id="betAmount" class="input" type="number" placeholder="Enter Amount (â‚¹)">
    </div>
    <div class="bet-buttons-row">
        <button id="betGreen" class="big-btn btn-green">
            <i class="fas fa-chart-line"></i> <span>Join Green</span>
        </button>
        <button id="betRed" class="big-btn btn-red">
            <i class="fas fa-chart-line"></i> <span>Join Red</span>
        </button>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="section-header">
      <span>Record</span>
      <div class="history-controls" style="display:flex; gap:10px;">
        <i class="fas fa-sync-alt" id="filterAll" style="cursor:pointer;"></i>
        <i class="fas fa-trash" id="clearHistory" style="cursor:pointer; color:#ef4444;"></i>
      </div>
      <div style="display:none;"><button id="filterWins"></button><button id="filterLosses"></button></div>
  </div>
  <div id="historyList" class="history-list"></div>

  <!-- ðŸ”¥ TOP WINNERS PODIUM & LIST ðŸ”¥ -->
  <div class="leaderboard-container">
      
      <!-- PODIUM (Rank 2 - Rank 1 - Rank 3) -->
      <div class="podium-box" id="podiumBox">
          <!-- JS will inject podium here -->
      </div>

      <!-- LIST (Rank 4 to 50) -->
      <div class="leaderboard-list">
          <div class="lb-header">
              <i class="fas fa-list-ol" style="color:#fbbf24;"></i> 
              Top Winners (Last 2 Hrs)
          </div>
          <div id="leaderboardList">
              <!-- JS Injects list here -->
          </div>
      </div>
  </div>

  <!-- FOOTER -->
  <div class="footer-menu">
      <div class="menu-item active"><i class="fas fa-home"></i> Home</div>
      <div class="menu-item" onclick="document.getElementById('termsModal').classList.add('active')"><i class="fas fa-book"></i> Rules</div>
      <div class="menu-item" onclick="document.getElementById('supportModal').classList.add('active')"><i class="fas fa-headset"></i> Support</div>
      <!-- CHANGE: Wallet now opens walletHistoryModal -->
      <div class="menu-item" onclick="window.openWalletHistory()"><i class="fas fa-wallet"></i> Wallet</div>
  </div>

</div>

<!-- MODALS -->
<div id="depositModal" class="modal-overlay">
  <div class="modal-content">
      <div class="modal-header">
          <div class="modal-title">Deposit Funds</div>
          <div class="close-icon" onclick="document.getElementById('depositModal').classList.remove('active')"><i class="fas fa-times"></i></div>
      </div>
      <div class="info-box" style="font-size:12px; color:#666; margin-bottom:15px; background:#f8f9fa; padding:10px; border-radius:8px; border-left:3px solid var(--primary-green);">
        <b>Scan & Pay First:</b><br>
            Min Deposit: <b>â‚¹50</b><br>
             1. Enter correct Amount & WhatsApp Number.<br>
                2. <b>Your Name</b>: Payment app (Paytm/PhonePe) par jo naam hai wo dalein.<br>
                3. Niche diye gaye QR par pehle Payment karein.<br>
                4. Payment successful hone ke baad <b>UTR Number</b> dalein</b>.
                <br> 5. 24hr kei under aapka money deposit ho jayega.<br>
      </div>
      <div class="qr" style="text-align:center; margin-bottom:15px;">
        <img src="https://image2url.com/images/1763823157163-01067a95-b7d0-4402-882e-8194a7135470.jfif" alt="QR Code" style="width:140px; border-radius:10px;">
      </div>
      <input id="depAmount" class="input" style="margin-bottom:10px;" type="number" placeholder="Amount (â‚¹)">
      <input id="depPhone" class="input" style="margin-bottom:10px;" type="text" placeholder="WhatsApp No.">
      <input id="depUtr" class="input" style="margin-bottom:10px;" type="text" placeholder="UTR / Reference No.">
      <input id="depSenderName" class="input" style="margin-bottom:10px;" type="text" placeholder="Your Name (on Payment App)">
      <button id="sendDeposit" class="std-btn btn-g">Submit Request</button>
  </div>
</div>

<div id="withdrawModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
        <div class="modal-title">Withdraw Funds</div>
        <div class="close-icon" onclick="document.getElementById('withdrawModal').classList.remove('active')"><i class="fas fa-times"></i></div>
    </div>
    <div style="font-size:12px; color:#666; margin-bottom:15px; border-left: 3px solid var(--primary-red); padding-left:10px;">
       
      <b>Note:</b> Min Withdraw: <b>â‚¹100</b><br>
            Withdrawals take up to 24 hours. 
             1. Enter correct Amount & WhatsApp Number.<br>
                2. <b>UPI ID / PhonePe</b>: Jis number/UPI par paisa chahiye, use sahi se bharein.<br>
                3. Galt details bharne par request reject ho sakti hai.
                <br>4. 24hr ke under aapka paisa aapke account mei add ho jayega.<br>
    </div>
    <input id="withAmount" class="input" style="margin-bottom:10px;" type="number" placeholder="Amount (â‚¹)">
    <input id="withPhone" class="input" style="margin-bottom:10px;" type="text" placeholder="WhatsApp No.">
    <input id="withUpi" class="input" style="margin-bottom:10px;" type="text" placeholder="UPI ID / PhonePe">
    <button id="sendWithdraw" class="std-btn btn-r">Request Withdraw</button>
    <div style="margin-top:20px; text-align:center; padding-top:10px; border-top:1px dashed #eee;">
        <span style="font-size:11px; color:#999;">LAST RESULT</span><br>
        <span id="lastResult" style="font-weight:700; font-size:16px; color:#333;">Waiting...</span>
    </div>
  </div>
</div>

<div id="termsModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
        <div class="modal-title">Rules</div>
        <div class="close-icon" onclick="document.getElementById('termsModal').classList.remove('active')"><i class="fas fa-times"></i></div>
    </div>
    <ul style="padding-left:20px; font-size:13px; color:#555; line-height:1.6;">
        <li>18+ Only.</li>
        <li>One account per person.</li>
        <li>Bets cannot be cancelled.</li>
        <li>Check UPI details carefully.</li>
    </ul>
    <button class="std-btn btn-r" style="margin-top:15px;" onclick="document.getElementById('termsModal').classList.remove('active')">Close</button>
  </div>
</div>

<div id="supportModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
        <div class="modal-title">Support</div>
        <div class="close-icon" onclick="document.getElementById('supportModal').classList.remove('active')"><i class="fas fa-times"></i></div>
    </div>
    <p style="text-align:center; font-size:13px; color:#555;">
        Insta: Neonbet7867<br>Email: support@neonbet.com
    </p>
    <a href="https://instagram.com/NeonBet7867" target="_blank" class="std-btn btn-g" style="display:block; text-align:center; text-decoration:none; margin-top:10px;">Open Instagram</a>
    <button class="std-btn" style="margin-top:10px; background:#ddd;" onclick="document.getElementById('supportModal').classList.remove('active')">Close</button>
  </div>
</div>

<!-- NEW WALLET HISTORY MODAL -->
<div id="walletHistoryModal" class="modal-overlay">
  <div class="modal-content">
      <div class="modal-header">
          <div class="modal-title">Wallet History</div>
          <div class="close-icon" onclick="document.getElementById('walletHistoryModal').classList.remove('active')"><i class="fas fa-times"></i></div>
      </div>
      <div id="walletHistoryList" class="history-list" style="max-height: 400px; overflow-y:auto; min-height:100px;">
          <div style="text-align:center; padding:20px; color:#aaa;">Loading...</div>
      </div>
      <button class="std-btn" style="margin-top:10px; background:#ddd;" onclick="document.getElementById('walletHistoryModal').classList.remove('active')">Close</button>
  </div>
</div>

<div id="popupContainer"></div>

<!-- JS LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp,
    onSnapshot, query, where, orderBy, getDocs, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDq_k2gcm-anr-PF-rdRU7DmoCbCgq5wXU",
    authDomain: "neonbet-10057.firebaseapp.com",
    projectId: "neonbet-10057",
    storageBucket: "neonbet-10057.firebasestorage.app",
    messagingSenderId: "256556059212",
    appId: "1:256556059212:web:b7178259089cea439a42e9",
    measurementId: "G-Z8HB5L8MYR"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const displayEmail = document.getElementById('displayEmail');
  const walletEl = document.getElementById('wallet');
  const logoutBtn = document.getElementById('logoutBtn');
  const betAmountEl = document.getElementById('betAmount');
  const betRedBtn = document.getElementById('betRed');
  const betGreenBtn = document.getElementById('betGreen');
  const timeLeftEl = document.getElementById('timeLeft');
  const roundNoEl = document.getElementById('roundNo');
  const lastResultEl = document.getElementById('lastResult');
  
  const depAmount = document.getElementById('depAmount');
  const depPhone = document.getElementById('depPhone');
  const depUtr = document.getElementById('depUtr');
  const depSenderName = document.getElementById('depSenderName');
  const sendDepositBtn = document.getElementById('sendDeposit');
  
  const withAmount = document.getElementById('withAmount');
  const withPhone = document.getElementById('withPhone');
  const withUpi = document.getElementById('withUpi');
  const sendWithdrawBtn = document.getElementById('sendWithdraw');

  const popupContainer = document.getElementById('popupContainer');
  let popupQueue = [], popupActive = false;
  const historyListEl = document.getElementById('historyList');
  const clearHistoryBtn = document.getElementById('clearHistory');
  const filterAllBtn = document.getElementById('filterAll');
  
  let GLOBAL_BET_LOCK = false;
  let GLOBAL_DEP_LOCK = false;
  let GLOBAL_WITH_LOCK = false;

  function showPopup(message, isWin) { popupQueue.push({message,isWin}); if(!popupActive) displayNextPopup(); }
  function displayNextPopup(){
    if(popupQueue.length===0){ popupActive=false; return; }
    popupActive=true; const {message,isWin}=popupQueue.shift();
    const el=document.createElement('div'); el.className=`popup ${isWin?'win':'lose'} show`; el.textContent=message;
    popupContainer.appendChild(el);
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>{ if(el.parentNode) popupContainer.removeChild(el); displayNextPopup(); },300); },3000);
  }

  let currentUser=null;
  let currentRound={round:1,endMs:Date.now()+60000};
  let timerInterval=null;
  let lastHandledFlagAt=Number(sessionStorage.getItem('lastHandledFlagAt')||0);
  const historyCacheMap = new Map(); 
  let activeFilter = 'all'; 

  // --- FAKE TICKER (EMAIL) ---
  const fakeNames = ["Arjun", "Rahul", "Priya", "Mohit", "Sara", "Ali", "John", "Deep", "Neha", "Kavya", "Arun", "Vikram", "Sneha", "Pooja", "Rohit", "Aman", "Kabir", "Zara", "Yash", "Tina", "Om", "Jay", "Veer", "Anu", "Shiv", "Dev", "Riya", "Nisha", "Ravi", "Simran", "Varun", "Aditya", "Kartik", "Ishaan", "Zoya"];
  
  function getFakeEmail() {
     const name = fakeNames[Math.floor(Math.random() * fakeNames.length)];
     const num = Math.floor(Math.random() * 90) + 10;
     return `${name.toLowerCase()}${num}***@gmail.com`;
  }

  function startFakeTicker() {
      setInterval(() => {
          const time = parseInt(timeLeftEl.innerText);
          if (isNaN(time) || time <= 0) return; 

          const tickerBox = document.getElementById('tickerBox');
          if(!tickerBox) return;

          const email = getFakeEmail();
          const amount = Math.floor(Math.random() * 40) * 50 + 50; 
          const div = document.createElement('div');
          div.className = 'tick-item';
          div.innerHTML = `<span style="font-size:12px; color:#555;">${email}</span> <span class="t-green">won â‚¹${amount}</span>`;
          tickerBox.prepend(div);
          if(tickerBox.children.length > 2) tickerBox.removeChild(tickerBox.lastChild);
      }, 2000 + Math.random() * 1000); 
  }
  startFakeTicker();

  // --- LEADERBOARD LOGIC (EMAIL + PODIUM + 50 USERS) ---
  function initLeaderboard() {
      const podiumEl = document.getElementById('podiumBox');
      const listEl = document.getElementById('leaderboardList');
      if(!podiumEl || !listEl) return;

      const TWO_HOURS_MS = 2 * 60 * 60 * 1000;
      let data = JSON.parse(localStorage.getItem('fakeLeaderboardData_v2'));
      let expiry = localStorage.getItem('fakeLeaderboardExpiry_v2');

      if (!data || !expiry || Date.now() > parseInt(expiry)) {
          data = [];
          for(let i=0; i<50; i++) {
              const name = fakeNames[Math.floor(Math.random() * fakeNames.length)];
              const email = `${name.toLowerCase()}${Math.floor(Math.random()*999)}***@gmail.com`;
              // Higher amount for top ranks
              let win;
              if(i < 3) win = Math.floor(Math.random() * 50000) + 40000;
              else win = Math.floor(Math.random() * 30000) + 1000;
              
              data.push({ name, email, win });
          }
          data.sort((a,b) => b.win - a.win); // Sort Highest First
          localStorage.setItem('fakeLeaderboardData_v2', JSON.stringify(data));
          localStorage.setItem('fakeLeaderboardExpiry_v2', Date.now() + TWO_HOURS_MS);
      }

      // Render Podium (Top 3)
      const top3 = data.slice(0, 3);
      podiumEl.innerHTML = `
          <div class="podium-item p-rank-2">
              <div class="p-avatar">${top3[1].name.charAt(0)}</div>
              <div class="p-name">${top3[1].email.split('@')[0]}</div>
              <div class="p-win">â‚¹${top3[1].win}</div>
          </div>
          <div class="podium-item p-rank-1">
              <div class="p-crown"><i class="fas fa-crown"></i></div>
              <div class="p-avatar">${top3[0].name.charAt(0)}</div>
              <div class="p-name">${top3[0].email.split('@')[0]}</div>
              <div class="p-win">â‚¹${top3[0].win}</div>
          </div>
          <div class="podium-item p-rank-3">
              <div class="p-avatar">${top3[2].name.charAt(0)}</div>
              <div class="p-name">${top3[2].email.split('@')[0]}</div>
              <div class="p-win">â‚¹${top3[2].win}</div>
          </div>
      `;

      // Render List (4 to 50)
      listEl.innerHTML = '';
      data.slice(3).forEach((item, index) => {
          const rank = index + 4;
          const div = document.createElement('div');
          div.className = 'lb-row';
          div.innerHTML = `
              <div class="lb-left">
                  <div class="lb-rank">${rank}</div>
                  <div class="lb-email">${item.email}</div>
              </div>
              <div class="lb-win">â‚¹${item.win}</div>
          `;
          listEl.appendChild(div);
      });
  }
  initLeaderboard();

  // --- STANDARD GAME LOGIC (SAME) ---
  function createHistoryElement(item){
    const el = document.createElement('div'); el.className = `hist-row`; el.dataset.id = item.id;
    const isWin = item.result === 'win'; const colorCode = item.color==='green' ? '#22c55e' : '#ef4444';
    el.innerHTML = `
      <div style="display:flex; align-items:center;">
        <span class="hist-badge" style="background:${colorCode}"></span>
        <div><div style="font-weight:600; font-size:14px; color:#333;">${(item.round)}</div>
           <div style="font-size:10px; color:#999;">${new Date(item.timestamp?.seconds * 1000 || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div></div>
      <div style="text-align:right">
        <div style="font-weight:700; color:${isWin ? '#22c55e' : '#ef4444'}">${isWin ? '+' : '-'} â‚¹${isWin ? item.winAmount : item.amount}</div>
        <div style="font-size:10px; color:#999;">${isWin ? 'Win' : 'Loss'}</div></div>`;
    return el;
  }

  function shouldShowByFilter(item){ if(activeFilter==='all') return true; if(activeFilter==='wins') return item.result==='win'; if(activeFilter==='losses') return item.result==='lose'; return true; }

  function addHistoryToUI(item, animate=true){
    if(!shouldShowByFilter(item)) return; if(historyListEl.querySelector(`[data-id="${item.id}"]`)) return;
    const el = createHistoryElement(item);
    if(animate){
      el.style.opacity='0'; el.style.transform='translateY(5px)'; historyListEl.insertBefore(el, historyListEl.firstChild);
      requestAnimationFrame(()=> { el.style.transition = 'all .2s'; el.style.opacity='1'; el.style.transform = 'none'; });
    } else {
        const nodes = Array.from(historyListEl.children);
        let inserted=false;
        for(let i=0;i<nodes.length;i++){
           const other=historyCacheMap.get(nodes[i].dataset.id);
           if(item.timestamp?.seconds >= other?.timestamp?.seconds){ historyListEl.insertBefore(el, nodes[i]); inserted=true; break; }
        }
        if(!inserted) historyListEl.appendChild(el);
    }
  }

  function updateHistoryInUI(item){ const existing = historyListEl.querySelector(`[data-id="${item.id}"]`); if(!existing){ addHistoryToUI(item, false); return; } existing.replaceWith(createHistoryElement(item)); }
  function removeHistoryFromUI(id){ const el = historyListEl.querySelector(`[data-id="${id}"]`); if(el) el.remove(); historyCacheMap.delete(id); if(historyListEl.children.length===0) historyListEl.innerHTML='<div style="text-align:center;color:#cbd5e1;font-size:12px;padding:10px;">No history</div>'; }
  function setFilter(f){ activeFilter = f; if(filterAllBtn) filterAllBtn.style.opacity = f==='all'?'1':'0.5'; historyListEl.innerHTML=''; const arr = Array.from(historyCacheMap.values()).sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0)); const filtered = arr.filter(shouldShowByFilter); if(filtered.length===0){ historyListEl.innerHTML='<div style="text-align:center;color:#cbd5e1;font-size:12px;padding:10px;">No history</div>'; return; } filtered.forEach(it=>historyListEl.appendChild(createHistoryElement(it))); }

  if(filterAllBtn) filterAllBtn.addEventListener('click', ()=>setFilter('all'));

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="index.html"; return; }
    document.querySelector('.wrap').style.display = (window.innerWidth <= 768) ? 'flex' : 'grid';
    currentUser=user;
    displayEmail.textContent=user.email;
    const userRef=doc(db,'users',user.uid);
    const uSnap=await getDoc(userRef);
    if(!uSnap.exists()) await setDoc(userRef,{email:user.email,name:user.email.split('@')[0],wallet:0});
    else walletEl.textContent=uSnap.data().wallet??0;
    onSnapshot(userRef,(snap)=>{ if(snap.exists()) walletEl.textContent=snap.data().wallet??0; });
    const roundRef=doc(db,'currentRound','main');
    onSnapshot(roundRef,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); currentRound.round=data.round??1; currentRound.endMs=data.endTime?.toMillis?data.endTime.toMillis():Number(data.endTime)||Date.now()+60000; roundNoEl.textContent=currentRound.round; startTimer(currentRound.endMs); });
    const declareFlagRef=doc(db,"results","declareFlag");
    onSnapshot(declareFlagRef, async (flagSnap)=>{ if(!flagSnap.exists()) return; const flag=flagSnap.data(); if(flag.declared===true && (Number(flag.at)||0) > lastHandledFlagAt){ try{ const latest=await getDoc(doc(db,"results","latest")); if(latest.exists()){ const data=latest.data(); lastResultEl.textContent=`${data.color?.toUpperCase()??"â€”"} (R${data.round??"-"})`; await processUserBetsAndWriteHistory(data.round, data.color); lastHandledFlagAt=Number(flag.at); sessionStorage.setItem('lastHandledFlagAt',String(lastHandledFlagAt)); } }catch(e){} } });
    onSnapshot(query(collection(db,'users',currentUser.uid,'history'), orderBy('timestamp','desc')), (snap) => {
      if(snap.empty && historyCacheMap.size===0) { historyListEl.innerHTML = '<div style="text-align:center;color:#cbd5e1;font-size:12px;padding:10px;">No history</div>'; return; }
      const isInitial = snap.metadata.hasPendingWrites === false && historyCacheMap.size===0;
      snap.docChanges().forEach(change => {
        const id = change.doc.id; const v = change.doc.data();
        if(change.type==='removed'){ removeHistoryFromUI(id); return; }
        const item = { id, ...v };
        if(change.type==='added'){ historyCacheMap.set(id, item); addHistoryToUI(item, !isInitial); }
        else if(change.type==='modified'){ historyCacheMap.set(id, item); updateHistoryInUI(item); }
      });
      if(isInitial && historyCacheMap.size>0) setFilter(activeFilter);
    });
  });

  function startTimer(endMs){
    if(timerInterval) clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
      const diff=Math.max(0,Math.floor((endMs-Date.now())/1000)); timeLeftEl.textContent=diff;
      if(!GLOBAL_BET_LOCK) { const dis = diff <= 0; betRedBtn.disabled=dis; betGreenBtn.disabled=dis; if(dis){ betRedBtn.classList.add('locked'); betGreenBtn.classList.add('locked'); } else { betRedBtn.classList.remove('locked'); betGreenBtn.classList.remove('locked'); } }
      if(diff<=0) clearInterval(timerInterval);
    },1000);
  }

  async function placeBet(color){
    if(GLOBAL_BET_LOCK) return;
    const amt=Number(betAmountEl.value); if(!amt || amt < 5) return alert('Min bet â‚¹5');
    GLOBAL_BET_LOCK = true; betRedBtn.classList.add('locked'); betGreenBtn.classList.add('locked'); betRedBtn.disabled = true; betGreenBtn.disabled = true;
    try{
      const userRef=doc(db,'users',currentUser.uid); const userSnap=await getDoc(userRef);
      const wallet=userSnap.exists()?Number(userSnap.data().wallet||0):0; if(wallet<amt) throw new Error('Low balance');
      await updateDoc(userRef,{wallet:wallet-amt});
      await addDoc(collection(db,'bets'),{ userId:currentUser.uid,userEmail:currentUser.email,color,amount:amt, round:currentRound.round??1,status:'pending', historyCreated: false, timestamp:serverTimestamp() });
      betAmountEl.value=''; showPopup(`Placed â‚¹${amt} on ${color}`, true);
    }catch(e){ alert('Error: '+e.message); } 
    finally { setTimeout(() => { if(parseInt(timeLeftEl.textContent)>0) { GLOBAL_BET_LOCK = false; betRedBtn.classList.remove('locked'); betGreenBtn.classList.remove('locked'); betRedBtn.disabled = false; betGreenBtn.disabled = false; } }, 1500); }
  }
  betRedBtn.addEventListener('click',(e)=>{ e.stopPropagation(); placeBet('red'); });
  betGreenBtn.addEventListener('click',(e)=>{ e.stopPropagation(); placeBet('green'); });

  async function processUserBetsAndWriteHistory(round, winner){
    try{ if(!currentUser || !round) return;
      const q = query(collection(db,'bets'), where('userId','==', currentUser.uid), where('round','==', round));
      const snap = await getDocs(q);
      for(const d of snap.docs){
        const bet = d.data(); if(bet.historyCreated) continue;
        const betColor = (bet.color||'').toString().toLowerCase(); const amount = Number(bet.amount||0);
        const isWin = betColor === (winner||'').toString().toLowerCase(); const winAmount = isWin ? (amount * 2) : 0;
        await setDoc(doc(db, 'users', currentUser.uid, 'history', d.id), { betId:d.id, amount, color: betColor, round, result: isWin ? 'win' : 'lose', winAmount, timestamp: serverTimestamp() });
        await updateDoc(doc(db, 'bets', d.id), { status: isWin ? 'win' : 'lose', historyCreated: true, settledAt: serverTimestamp() });
        showPopup(isWin ? `WON â‚¹${winAmount}` : `LOST â‚¹${amount}`, isWin);
      }
    }catch(e){}
  }

  clearHistoryBtn.addEventListener('click', async ()=>{ if(!confirm('Clear history?')) return; historyListEl.innerHTML='Clearing...'; historyCacheMap.clear(); const snap = await getDocs(collection(db, 'users', currentUser.uid, 'history')); await Promise.all(snap.docs.map(d => deleteDoc(d.ref))); historyListEl.innerHTML='<div style="text-align:center;color:#cbd5e1;font-size:12px;padding:10px;">No history</div>'; });
  
  sendDepositBtn.addEventListener('click', async function(e){ e.stopPropagation(); if(GLOBAL_DEP_LOCK) return; const amt=Number(depAmount.value); if(!amt||!depPhone.value||!depUtr.value||!depSenderName.value) return alert('Fill details'); if(amt<50) return alert('Min â‚¹50'); GLOBAL_DEP_LOCK = true; this.classList.add('locked'); this.textContent = 'Processing...'; try{ await addDoc(collection(db,'depositRequests'),{ userId:currentUser.uid, userEmail:currentUser.email, amount:amt, phone:depPhone.value, utr:depUtr.value, senderName: depSenderName.value, status:'pending', timestamp:serverTimestamp() }); depAmount.value=''; showPopup('Request Sent', true); document.getElementById('depositModal').classList.remove('active'); }catch(e){ alert(e.message); } finally { this.classList.remove('locked'); this.textContent='Submit Request'; GLOBAL_DEP_LOCK = false; } });
  
  sendWithdrawBtn.addEventListener('click', async function(e){ e.stopPropagation(); if(GLOBAL_WITH_LOCK) return; const amt=Number(withAmount.value); if(!amt||!withPhone.value) return alert('Fill details'); if(amt<100) return alert('Min â‚¹100'); GLOBAL_WITH_LOCK = true; this.classList.add('locked'); this.textContent = 'Processing...'; try{ const userRef=doc(db,'users',currentUser.uid); const uSnap=await getDoc(userRef); if((uSnap.data().wallet||0)<amt) throw new Error('Low balance'); await updateDoc(userRef,{wallet:(uSnap.data().wallet||0)-amt}); await addDoc(collection(db,'withdrawRequests'),{ userId:currentUser.uid,userEmail:currentUser.email,amount:amt,phone:withPhone.value,upi:withUpi.value,status:'pending',refunded:false,timestamp:serverTimestamp() }); withAmount.value=''; showPopup('Request Sent', true); document.getElementById('withdrawModal').classList.remove('active'); }catch(e){ alert(e.message); } finally { this.classList.remove('locked'); this.textContent='Request Withdraw'; GLOBAL_WITH_LOCK = false; } });

  logoutBtn.addEventListener('click',()=>signOut(auth));

  // --- NEW WALLET HISTORY LOGIC ---
  window.openWalletHistory = async () => {
    document.getElementById('walletHistoryModal').classList.add('active');
    const list = document.getElementById('walletHistoryList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Loading...</div>';

    if(!currentUser) return;

    try {
        const dQ = query(collection(db, 'depositRequests'), where('userId', '==', currentUser.uid));
        const wQ = query(collection(db, 'withdrawRequests'), where('userId', '==', currentUser.uid));

        const [dSnap, wSnap] = await Promise.all([getDocs(dQ), getDocs(wQ)]);

        let events = [];
        dSnap.forEach(doc => events.push({ ...doc.data(), type: 'Deposit', id: doc.id }));
        wSnap.forEach(doc => events.push({ ...doc.data(), type: 'Withdraw', id: doc.id }));

        events.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        if(events.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">No transactions found.</div>';
            return;
        }

        list.innerHTML = '';
        events.forEach(item => {
            const isDep = item.type === 'Deposit';
            const dateStr = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString() : 'Just now';
            const statusColor = item.status === 'success' || item.status === 'approved' ? '#22c55e' : (item.status === 'pending' ? '#f59e0b' : '#ef4444');
            
            const div = document.createElement('div');
            div.className = 'hist-row';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div style="width:35px; height:35px; background:${isDep ? '#dcfce7' : '#fee2e2'}; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:10px; color:${isDep ? '#16a34a' : '#dc2626'};">
                        <i class="fas fa-${isDep ? 'arrow-up' : 'arrow-down'}"></i>
                    </div>
                    <div>
                        <div style="font-weight:700; font-size:13px; color:#333;">${item.type}</div>
                        <div style="font-size:10px; color:#999;">${dateStr}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:700; font-size:14px; color:${isDep ? '#22c55e' : '#333'}">${isDep?'+':'-'} â‚¹${item.amount}</div>
                    <div style="font-size:10px; font-weight:600; text-transform:uppercase; color:${statusColor}">${item.status}</div>
                </div>
            `;
            list.appendChild(div);
        });

    } catch(e) {
        console.error(e);
        list.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading history.</div>';
    }
  };
</script>

</body>
</html>